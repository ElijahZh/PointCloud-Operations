
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../color/">
      
      
        <link rel="next" href="../tensor/">
      
      
        
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Noise - Point Cloud Operations</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.618322db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#addoutlier" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Point Cloud Operations" class="md-header__button md-logo" aria-label="Point Cloud Operations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Point Cloud Operations
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Noise
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Point Cloud Operations" class="md-nav__button md-logo" aria-label="Point Cloud Operations" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Point Cloud Operations
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sample_mesh/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SamplingMesh
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sample/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SamplingPC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../coord/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coordinate
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../norm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Normal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../color/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Color
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Noise
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Noise
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#addoutlier" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddOutlier
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddOutlier.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addbackgroundnoise" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddBackgroundNoise
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddBackgroundNoise.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addnoise" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddNoise
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddNoise.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tensor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tensor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../about/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    About
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#addoutlier" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddOutlier
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddOutlier.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addbackgroundnoise" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddBackgroundNoise
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddBackgroundNoise.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#addnoise" class="md-nav__link">
    <span class="md-ellipsis">
      
        AddNoise
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#augmentation_class.AddNoise.__call__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __call__
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Noise</h1>

<!-- ## Noise -->

<p>Classes for adding noise into point cloud</p>
<h2 id="addoutlier">AddOutlier</h2>


<div class="doc doc-object doc-class">




    <div class="doc doc-contents first">



        <p>Add synthetic outlier points (and attributes) around a point cloud.</p>
<p>This transform expects a dictionary containing:</p>
<ul>
<li><code>"coord"</code>: NumPy array of shape (N, 3) with point coordinates.</li>
<li>Optionally <code>"norm"</code>: per-point normals of shape (N, 3).</li>
<li>Optionally <code>"color"</code>: per-point colors of shape (N, C).</li>
<li>Optionally <code>"noise_index"</code>: 1D array of length N indicating noise labels (existing noise index).</li>
</ul>
<p>It augments the point cloud by sampling additional points in a spherical shell around the existing point cloud
and appends them (and their attributes) to the existing arrays.</p>
<p>The N number of outliers is:</p>
<pre><code>N = int(max_ratio * n_pts)
</code></pre>
<p>where <code>n_pts</code> is the original number of points. If this is 0, the transform
does nothing.</p>
<p>Behavior of <code>fixed</code>:</p>
<ul>
<li>If <code>fixed=False</code>:</li>
<li>Use <strong>all</strong> <code>N</code> generated outliers.</li>
<li>If <code>fixed=True</code>:</li>
<li>
<p>Randomly choose a subset of the outliers with size:</p>
<pre><code>N_used ∼ Uniform{ N // 2, ..., N }
</code></pre>
<p>and only append this subset.</p>
</li>
</ul>
<p>Outliers are sampled inside a spherical shell defined from the centroid
and bounding radius:</p>
<ol>
<li>
<p>Compute the centroid:</p>
<p>center = mean(coord, axis=0)</p>
</li>
<li>
<p>Compute the maximum radius from the centroid:</p>
<p>r_max = max(||coord[i] - center||)</p>
</li>
<li>
<p>Define a spherical shell with inner radius:</p>
<p>r_min = radius_min * r_max</p>
</li>
</ol>
<p>and outer radius:</p>
<pre><code>   r_max_shell = r_max
</code></pre>
<ol>
<li>Sample directions uniformly on the sphere and radii uniformly in <strong>volume</strong> within <code>[r_min, r_max_shell]</code>,
   then map back to world coordinates.</li>
</ol>
<p>For each outlier point, a random unit normal is generated (if <code>"norm"</code> exists), and random colors are generated
(if <code>"color"</code> exists).</p>
<p>The <code>"noise_index"</code> field is updated as follows:</p>
<ul>
<li>If <code>"noise_index"</code> does not exist:</li>
<li>A new array of length <code>N + N_used</code> is created, filled with 0 for original points and 3
  (indication of outlier type noise) for new outliers.</li>
<li>If <code>"noise_index"</code> exists:</li>
<li>It is extended to length <code>N + N_used</code>, keeping existing values and setting all new entries to 3.</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_ratio</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum ratio of outliers to original points. The N number of generated outliers is:</p>
<pre><code>N = int(max_ratio * n_pts)
</code></pre>
<p>where n_pts is the original point count.
Defaults to 0.2.</p>
              </div>
            </td>
            <td>
                  <code>0.2</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fixed</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls whether to subsample the generated outliers:</p>
<ul>
<li>False → use all generated outliers (<code>N</code>).</li>
<li>True → randomly select a subset of size between <code>N // 2</code> and <code>N</code> (inclusive).
Defaults to False.</li>
</ul>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>radius_min</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of the maximum radius used as the inner radius of the sampling shell. The shell is defined as
<code>[radius_min * r_max, r_max]</code>.
Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range255</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether <code>"color"</code> values are in <code>[0, 255]</code>. If True, outlier colors are sampled as
integers in <code>[0, 255]</code>. If False, they are sampled as floats in <code>[0, 1]</code>.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_p</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of applying the adding outliers.
Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src\augmentation_class.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2279</span>
<span class="normal">2280</span>
<span class="normal">2281</span>
<span class="normal">2282</span>
<span class="normal">2283</span>
<span class="normal">2284</span>
<span class="normal">2285</span>
<span class="normal">2286</span>
<span class="normal">2287</span>
<span class="normal">2288</span>
<span class="normal">2289</span>
<span class="normal">2290</span>
<span class="normal">2291</span>
<span class="normal">2292</span>
<span class="normal">2293</span>
<span class="normal">2294</span>
<span class="normal">2295</span>
<span class="normal">2296</span>
<span class="normal">2297</span>
<span class="normal">2298</span>
<span class="normal">2299</span>
<span class="normal">2300</span>
<span class="normal">2301</span>
<span class="normal">2302</span>
<span class="normal">2303</span>
<span class="normal">2304</span>
<span class="normal">2305</span>
<span class="normal">2306</span>
<span class="normal">2307</span>
<span class="normal">2308</span>
<span class="normal">2309</span>
<span class="normal">2310</span>
<span class="normal">2311</span>
<span class="normal">2312</span>
<span class="normal">2313</span>
<span class="normal">2314</span>
<span class="normal">2315</span>
<span class="normal">2316</span>
<span class="normal">2317</span>
<span class="normal">2318</span>
<span class="normal">2319</span>
<span class="normal">2320</span>
<span class="normal">2321</span>
<span class="normal">2322</span>
<span class="normal">2323</span>
<span class="normal">2324</span>
<span class="normal">2325</span>
<span class="normal">2326</span>
<span class="normal">2327</span>
<span class="normal">2328</span>
<span class="normal">2329</span>
<span class="normal">2330</span>
<span class="normal">2331</span>
<span class="normal">2332</span>
<span class="normal">2333</span>
<span class="normal">2334</span>
<span class="normal">2335</span>
<span class="normal">2336</span>
<span class="normal">2337</span>
<span class="normal">2338</span>
<span class="normal">2339</span>
<span class="normal">2340</span>
<span class="normal">2341</span>
<span class="normal">2342</span>
<span class="normal">2343</span>
<span class="normal">2344</span>
<span class="normal">2345</span>
<span class="normal">2346</span>
<span class="normal">2347</span>
<span class="normal">2348</span>
<span class="normal">2349</span>
<span class="normal">2350</span>
<span class="normal">2351</span>
<span class="normal">2352</span>
<span class="normal">2353</span>
<span class="normal">2354</span>
<span class="normal">2355</span>
<span class="normal">2356</span>
<span class="normal">2357</span>
<span class="normal">2358</span>
<span class="normal">2359</span>
<span class="normal">2360</span>
<span class="normal">2361</span>
<span class="normal">2362</span>
<span class="normal">2363</span>
<span class="normal">2364</span>
<span class="normal">2365</span>
<span class="normal">2366</span>
<span class="normal">2367</span>
<span class="normal">2368</span>
<span class="normal">2369</span>
<span class="normal">2370</span>
<span class="normal">2371</span>
<span class="normal">2372</span>
<span class="normal">2373</span>
<span class="normal">2374</span>
<span class="normal">2375</span>
<span class="normal">2376</span>
<span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@TRANSFORMS</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AddOutlier</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add synthetic outlier points (and attributes) around a point cloud.</span>

<span class="sd">    This transform expects a dictionary containing:</span>

<span class="sd">    * `&quot;coord&quot;`: NumPy array of shape (N, 3) with point coordinates.</span>
<span class="sd">    * Optionally `&quot;norm&quot;`: per-point normals of shape (N, 3).</span>
<span class="sd">    * Optionally `&quot;color&quot;`: per-point colors of shape (N, C).</span>
<span class="sd">    * Optionally `&quot;noise_index&quot;`: 1D array of length N indicating noise labels (existing noise index).</span>

<span class="sd">    It augments the point cloud by sampling additional points in a spherical shell around the existing point cloud</span>
<span class="sd">    and appends them (and their attributes) to the existing arrays.</span>

<span class="sd">    The N number of outliers is:</span>

<span class="sd">        N = int(max_ratio * n_pts)</span>

<span class="sd">    where ``n_pts`` is the original number of points. If this is 0, the transform</span>
<span class="sd">    does nothing.</span>

<span class="sd">    Behavior of ``fixed``:</span>

<span class="sd">    * If ``fixed=False``:</span>
<span class="sd">      - Use **all** `N` generated outliers.</span>
<span class="sd">    * If ``fixed=True``:</span>
<span class="sd">      - Randomly choose a subset of the outliers with size:</span>

<span class="sd">            N_used ∼ Uniform{ N // 2, ..., N }</span>

<span class="sd">        and only append this subset.</span>

<span class="sd">    Outliers are sampled inside a spherical shell defined from the centroid</span>
<span class="sd">    and bounding radius:</span>

<span class="sd">    1. Compute the centroid:</span>

<span class="sd">           center = mean(coord, axis=0)</span>

<span class="sd">    2. Compute the maximum radius from the centroid:</span>

<span class="sd">           r_max = max(||coord[i] - center||)</span>

<span class="sd">    3. Define a spherical shell with inner radius:</span>

<span class="sd">           r_min = radius_min * r_max</span>

<span class="sd">       and outer radius:</span>

<span class="sd">           r_max_shell = r_max</span>

<span class="sd">    4. Sample directions uniformly on the sphere and radii uniformly in **volume** within `[r_min, r_max_shell]`,</span>
<span class="sd">       then map back to world coordinates.</span>

<span class="sd">    For each outlier point, a random unit normal is generated (if `&quot;norm&quot;` exists), and random colors are generated</span>
<span class="sd">    (if `&quot;color&quot;` exists).</span>

<span class="sd">    The `&quot;noise_index&quot;` field is updated as follows:</span>

<span class="sd">    * If `&quot;noise_index&quot;` does not exist:</span>
<span class="sd">      - A new array of length `N + N_used` is created, filled with 0 for original points and 3</span>
<span class="sd">      (indication of outlier type noise) for new outliers.</span>
<span class="sd">    * If `&quot;noise_index&quot;` exists:</span>
<span class="sd">      - It is extended to length `N + N_used`, keeping existing values and setting all new entries to 3.</span>

<span class="sd">    Args:</span>
<span class="sd">        max_ratio (float, optional):</span>
<span class="sd">            Maximum ratio of outliers to original points. The N number of generated outliers is:</span>

<span class="sd">                N = int(max_ratio * n_pts)</span>

<span class="sd">            where n_pts is the original point count.</span>
<span class="sd">            Defaults to 0.2.</span>
<span class="sd">        fixed (bool, optional):</span>
<span class="sd">            Controls whether to subsample the generated outliers:</span>

<span class="sd">            * False → use all generated outliers (`N`).</span>
<span class="sd">            * True → randomly select a subset of size between `N // 2` and `N` (inclusive).</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        radius_min (float, optional):</span>
<span class="sd">            Fraction of the maximum radius used as the inner radius of the sampling shell. The shell is defined as</span>
<span class="sd">            `[radius_min * r_max, r_max]`.</span>
<span class="sd">            Defaults to 0.5.</span>
<span class="sd">        range255 (bool, optional): Whether `&quot;color&quot;` values are in `[0, 255]`. If True, outlier colors are sampled as</span>
<span class="sd">            integers in `[0, 255]`. If False, they are sampled as floats in `[0, 1]`.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        apply_p (float, optional):</span>
<span class="sd">            Probability of applying the adding outliers.</span>
<span class="sd">            Defaults to 1.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_ratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">radius_min</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">range255</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_p</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_ratio</span> <span class="o">=</span> <span class="n">max_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_min</span> <span class="o">=</span> <span class="n">radius_min</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range255</span> <span class="o">=</span> <span class="n">range255</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span> <span class="o">=</span> <span class="n">apply_p</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add outlier points and update aligned per-point attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dict (dict): Input dictionary containing `&quot;coord&quot;` and optionally `&quot;norm&quot;`, `&quot;color&quot;`, and `&quot;noise_index&quot;`.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The same dictionary with additional outlier points and updated attributes, if adding outliers is applied.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
        <span class="n">n_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

        <span class="c1"># how many outliers to add</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ratio</span> <span class="o">*</span> <span class="n">n_pts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="c1"># --- define a bounding sphere from current coords ---</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (1,3)</span>
        <span class="n">rel</span> <span class="o">=</span> <span class="n">coord</span> <span class="o">-</span> <span class="n">center</span>  <span class="c1"># (N,3)</span>
        <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-6</span>  <span class="c1"># avoid zero</span>

        <span class="n">r_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_min</span> <span class="o">*</span> <span class="n">r_max</span>
        <span class="n">r_max_shell</span> <span class="o">=</span> <span class="n">r_max</span>  <span class="c1"># you can change to &gt; r_max if you want truly outside</span>
        <span class="c1"># --- sample directions uniformly on sphere ---</span>
        <span class="n">noise_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Gaussian</span>
        <span class="n">noise_dir</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">noise_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># normalize</span>
        <span class="c1"># --- sample radii uniformly in the volume shell [r_min, r_max_shell] ---</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
        <span class="c1"># uniform in [r_min^3, r_max^3], then cube root → uniform in volume</span>
        <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_min</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_max_shell</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">r_min</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">noise_dir</span> <span class="o">*</span> <span class="n">r</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (N,3) in bounding shell</span>
        <span class="n">noise_coord</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">noise</span>  <span class="c1"># map back to world coords</span>

        <span class="c1"># add normal</span>
        <span class="n">rand_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">noise_coord</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># gaussian noise</span>
        <span class="c1"># normalize to unit vectors</span>
        <span class="n">norm_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rand_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">noise_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_dir</span> <span class="o">/</span> <span class="n">norm_len</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="c1"># noise_normal = noise_dir              # or use direction as &quot;normal&quot;</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># choose subset size between N // 2 and N (inclusive)</span>
            <span class="n">k_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">idx_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">noise_coord</span> <span class="o">=</span> <span class="n">noise_coord</span><span class="p">[</span><span class="n">idx_sel</span><span class="p">]</span>
            <span class="n">noise_normal</span> <span class="o">=</span> <span class="n">noise_normal</span><span class="p">[</span><span class="n">idx_sel</span><span class="p">]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">k</span>

        <span class="c1"># ----- add coords -----</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">noise_coord</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># ----- add normals (if present) -----</span>
        <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">noise_normal</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="c1"># ----- add color for outliers (if present) -----</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">orig_color</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
                <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_color</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># ----- update noise_index -----</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">noise_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">noise_index</span><span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># mark new outliers as 3</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
            <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="n">tmp</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="augmentation_class.AddOutlier.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add outlier points and update aligned per-point attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary containing <code>"coord"</code> and optionally <code>"norm"</code>, <code>"color"</code>, and <code>"noise_index"</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The same dictionary with additional outlier points and updated attributes, if adding outliers is applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src\augmentation_class.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2377</span>
<span class="normal">2378</span>
<span class="normal">2379</span>
<span class="normal">2380</span>
<span class="normal">2381</span>
<span class="normal">2382</span>
<span class="normal">2383</span>
<span class="normal">2384</span>
<span class="normal">2385</span>
<span class="normal">2386</span>
<span class="normal">2387</span>
<span class="normal">2388</span>
<span class="normal">2389</span>
<span class="normal">2390</span>
<span class="normal">2391</span>
<span class="normal">2392</span>
<span class="normal">2393</span>
<span class="normal">2394</span>
<span class="normal">2395</span>
<span class="normal">2396</span>
<span class="normal">2397</span>
<span class="normal">2398</span>
<span class="normal">2399</span>
<span class="normal">2400</span>
<span class="normal">2401</span>
<span class="normal">2402</span>
<span class="normal">2403</span>
<span class="normal">2404</span>
<span class="normal">2405</span>
<span class="normal">2406</span>
<span class="normal">2407</span>
<span class="normal">2408</span>
<span class="normal">2409</span>
<span class="normal">2410</span>
<span class="normal">2411</span>
<span class="normal">2412</span>
<span class="normal">2413</span>
<span class="normal">2414</span>
<span class="normal">2415</span>
<span class="normal">2416</span>
<span class="normal">2417</span>
<span class="normal">2418</span>
<span class="normal">2419</span>
<span class="normal">2420</span>
<span class="normal">2421</span>
<span class="normal">2422</span>
<span class="normal">2423</span>
<span class="normal">2424</span>
<span class="normal">2425</span>
<span class="normal">2426</span>
<span class="normal">2427</span>
<span class="normal">2428</span>
<span class="normal">2429</span>
<span class="normal">2430</span>
<span class="normal">2431</span>
<span class="normal">2432</span>
<span class="normal">2433</span>
<span class="normal">2434</span>
<span class="normal">2435</span>
<span class="normal">2436</span>
<span class="normal">2437</span>
<span class="normal">2438</span>
<span class="normal">2439</span>
<span class="normal">2440</span>
<span class="normal">2441</span>
<span class="normal">2442</span>
<span class="normal">2443</span>
<span class="normal">2444</span>
<span class="normal">2445</span>
<span class="normal">2446</span>
<span class="normal">2447</span>
<span class="normal">2448</span>
<span class="normal">2449</span>
<span class="normal">2450</span>
<span class="normal">2451</span>
<span class="normal">2452</span>
<span class="normal">2453</span>
<span class="normal">2454</span>
<span class="normal">2455</span>
<span class="normal">2456</span>
<span class="normal">2457</span>
<span class="normal">2458</span>
<span class="normal">2459</span>
<span class="normal">2460</span>
<span class="normal">2461</span>
<span class="normal">2462</span>
<span class="normal">2463</span>
<span class="normal">2464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add outlier points and update aligned per-point attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): Input dictionary containing `&quot;coord&quot;` and optionally `&quot;norm&quot;`, `&quot;color&quot;`, and `&quot;noise_index&quot;`.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The same dictionary with additional outlier points and updated attributes, if adding outliers is applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
    <span class="n">n_pts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>

    <span class="c1"># how many outliers to add</span>
    <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_ratio</span> <span class="o">*</span> <span class="n">n_pts</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">N</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="c1"># --- define a bounding sphere from current coords ---</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># (1,3)</span>
    <span class="n">rel</span> <span class="o">=</span> <span class="n">coord</span> <span class="o">-</span> <span class="n">center</span>  <span class="c1"># (N,3)</span>
    <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rel</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-6</span>  <span class="c1"># avoid zero</span>

    <span class="n">r_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_min</span> <span class="o">*</span> <span class="n">r_max</span>
    <span class="n">r_max_shell</span> <span class="o">=</span> <span class="n">r_max</span>  <span class="c1"># you can change to &gt; r_max if you want truly outside</span>
    <span class="c1"># --- sample directions uniformly on sphere ---</span>
    <span class="n">noise_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>  <span class="c1"># Gaussian</span>
    <span class="n">noise_dir</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">noise_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># normalize</span>
    <span class="c1"># --- sample radii uniformly in the volume shell [r_min, r_max_shell] ---</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="c1"># uniform in [r_min^3, r_max^3], then cube root → uniform in volume</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r_min</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="n">r_max_shell</span> <span class="o">**</span> <span class="mi">3</span> <span class="o">-</span> <span class="n">r_min</span> <span class="o">**</span> <span class="mi">3</span><span class="p">))</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">noise_dir</span> <span class="o">*</span> <span class="n">r</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (N,3) in bounding shell</span>
    <span class="n">noise_coord</span> <span class="o">=</span> <span class="n">center</span> <span class="o">+</span> <span class="n">noise</span>  <span class="c1"># map back to world coords</span>

    <span class="c1"># add normal</span>
    <span class="n">rand_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">noise_coord</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># gaussian noise</span>
    <span class="c1"># normalize to unit vectors</span>
    <span class="n">norm_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rand_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
    <span class="n">noise_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_dir</span> <span class="o">/</span> <span class="n">norm_len</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="c1"># noise_normal = noise_dir              # or use direction as &quot;normal&quot;</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">and</span> <span class="n">N</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># choose subset size between N // 2 and N (inclusive)</span>
        <span class="n">k_min</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">N</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">k_min</span><span class="p">,</span> <span class="n">N</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx_sel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">noise_coord</span> <span class="o">=</span> <span class="n">noise_coord</span><span class="p">[</span><span class="n">idx_sel</span><span class="p">]</span>
        <span class="n">noise_normal</span> <span class="o">=</span> <span class="n">noise_normal</span><span class="p">[</span><span class="n">idx_sel</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">k</span>

    <span class="c1"># ----- add coords -----</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">noise_coord</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ----- add normals (if present) -----</span>
    <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">noise_normal</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># ----- add color for outliers (if present) -----</span>
    <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">orig_color</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
            <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_color</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ----- update noise_index -----</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">noise_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">noise_index</span><span class="p">[</span><span class="o">-</span><span class="n">N</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># mark new outliers as 3</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span>
        <span class="n">tmp</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Adding Outlier Noise</strong></p>
<p align="center">
  <img src="../img/AddOutlier1.png" alt="Before" style="width:48%; max-width:48%; height:auto; margin-right:1%;">
  <img src="../img/AddOutlier2.png" alt="After" style="width:48%; max-width:48%; height:auto; margin-left:1%;">
</p>

<h2 id="addbackgroundnoise">AddBackgroundNoise</h2>


<div class="doc doc-object doc-class">




    <div class="doc doc-contents first">



        <p>Add structured background noise patches around a point cloud.</p>
<p>This transform expects a dictionary containing:</p>
<ul>
<li><code>"coord"</code>: NumPy array of shape (N, 3) with point coordinates.</li>
<li>Optionally <code>"norm"</code>: per-point normals of shape (N, 3).</li>
<li>Optionally <code>"color"</code>: per-point colors of shape (N, C).</li>
<li>Optionally <code>"noise_index"</code>: 1D array of length N indicating noise labels (existing noise index).</li>
</ul>
<p>It generates several small 3D regions (up to <code>max_regions</code>), each containing up to <code>region_max_k</code> random points.
These regions are anchored to the bounding box of the (non-noise) point cloud and then added as background clutter:</p>
<pre><code>1. Compute the axis-aligned bounding box (AABB) from points with ``noise_index == 0`` (or all points if ``noise_index`` is absent).
2. Sample up to ``max_regions`` random centers inside the box (with behavior controlled by ``mode``).
3. For each region, sample points uniformly in a cube of side length ``region_size`` around the center.
4. Snap one coordinate of each region to one face of the bounding box, so that noise patches lie on or around the box surface.
5. Generate random unit normals for these noise points.
6. Optionally subsample a random subset of regions/points when ``fixed=False``.
7. Concatenate noise coordinates, normals, and colors (if present) to the existing arrays, and update ``noise_index`` to mark them asbackground noise (label 2).
</code></pre>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>max_regions</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of noise regions to generate. Each region is a local cube of sampled noise points.
Defaults to 8.</p>
              </div>
            </td>
            <td>
                  <code>8</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>region_max_k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of points per region before optional subsampling. Total initial noise points are
roughly <code>max_regions * region_max_k</code> before any reduction.
Defaults to 128.</p>
              </div>
            </td>
            <td>
                  <code>128</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>region_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Side length of each cubic noise region. Points are sampled uniformly in a cube of side <code>region_size</code>
centered at each region center.
Defaults to 0.5.</p>
              </div>
            </td>
            <td>
                  <code>0.5</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fixed</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls randomness and subsampling of the generated noise:
* If <code>False</code>:
  - Randomly choose a number of regions between 1 and <code>max_regions</code>.
  - Flatten all noise points from those regions.
  - Randomly select a subset of points, with size between roughly 1/8 of all region points and the full set.
* If <code>True</code>:
  - Use all <code>max_regions * region_max_k</code> points (no region or point subsampling).</p>
<p>Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range255</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether color values are in the range <code>[0, 255]</code>. If True, noise colors are sampled as integers in
<code>[0, 255]</code>. If False, noise colors are sampled as floats in <code>[0, 1]</code>.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mode</code>
            </td>
            <td>
                  <code>{<span title="outside">outside</span>, <span title="inside">inside</span>}</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Controls how the region
centers are chosen relative to the bounding box:</p>
<ul>
<li><code>"inside"</code>:</li>
<li>Region centers are chosen so that the entire noise cube (of side <code>region_size</code>) lies strictly inside the bounding
    box, as much as possible. This ensures all noise points stay on/within the box volume.</li>
<li><code>"outside"</code>:</li>
<li>Region centers are sampled anywhere inside the bounding box, and one coordinate of each region is snapped to a box face.
    Some noise points may lie slightly outside the box, mimicking more realistic background clutter.</li>
</ul>
<p>Defaults to <code>"outside"</code>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;outside&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_p</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of applying the background
Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src\augmentation_class.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2466</span>
<span class="normal">2467</span>
<span class="normal">2468</span>
<span class="normal">2469</span>
<span class="normal">2470</span>
<span class="normal">2471</span>
<span class="normal">2472</span>
<span class="normal">2473</span>
<span class="normal">2474</span>
<span class="normal">2475</span>
<span class="normal">2476</span>
<span class="normal">2477</span>
<span class="normal">2478</span>
<span class="normal">2479</span>
<span class="normal">2480</span>
<span class="normal">2481</span>
<span class="normal">2482</span>
<span class="normal">2483</span>
<span class="normal">2484</span>
<span class="normal">2485</span>
<span class="normal">2486</span>
<span class="normal">2487</span>
<span class="normal">2488</span>
<span class="normal">2489</span>
<span class="normal">2490</span>
<span class="normal">2491</span>
<span class="normal">2492</span>
<span class="normal">2493</span>
<span class="normal">2494</span>
<span class="normal">2495</span>
<span class="normal">2496</span>
<span class="normal">2497</span>
<span class="normal">2498</span>
<span class="normal">2499</span>
<span class="normal">2500</span>
<span class="normal">2501</span>
<span class="normal">2502</span>
<span class="normal">2503</span>
<span class="normal">2504</span>
<span class="normal">2505</span>
<span class="normal">2506</span>
<span class="normal">2507</span>
<span class="normal">2508</span>
<span class="normal">2509</span>
<span class="normal">2510</span>
<span class="normal">2511</span>
<span class="normal">2512</span>
<span class="normal">2513</span>
<span class="normal">2514</span>
<span class="normal">2515</span>
<span class="normal">2516</span>
<span class="normal">2517</span>
<span class="normal">2518</span>
<span class="normal">2519</span>
<span class="normal">2520</span>
<span class="normal">2521</span>
<span class="normal">2522</span>
<span class="normal">2523</span>
<span class="normal">2524</span>
<span class="normal">2525</span>
<span class="normal">2526</span>
<span class="normal">2527</span>
<span class="normal">2528</span>
<span class="normal">2529</span>
<span class="normal">2530</span>
<span class="normal">2531</span>
<span class="normal">2532</span>
<span class="normal">2533</span>
<span class="normal">2534</span>
<span class="normal">2535</span>
<span class="normal">2536</span>
<span class="normal">2537</span>
<span class="normal">2538</span>
<span class="normal">2539</span>
<span class="normal">2540</span>
<span class="normal">2541</span>
<span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@TRANSFORMS</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AddBackgroundNoise</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add structured background noise patches around a point cloud.</span>

<span class="sd">    This transform expects a dictionary containing:</span>

<span class="sd">    * `&quot;coord&quot;`: NumPy array of shape (N, 3) with point coordinates.</span>
<span class="sd">    * Optionally `&quot;norm&quot;`: per-point normals of shape (N, 3).</span>
<span class="sd">    * Optionally `&quot;color&quot;`: per-point colors of shape (N, C).</span>
<span class="sd">    * Optionally `&quot;noise_index&quot;`: 1D array of length N indicating noise labels (existing noise index).</span>

<span class="sd">    It generates several small 3D regions (up to ``max_regions``), each containing up to ``region_max_k`` random points.</span>
<span class="sd">    These regions are anchored to the bounding box of the (non-noise) point cloud and then added as background clutter:</span>

<span class="sd">        1. Compute the axis-aligned bounding box (AABB) from points with ``noise_index == 0`` (or all points if ``noise_index`` is absent).</span>
<span class="sd">        2. Sample up to ``max_regions`` random centers inside the box (with behavior controlled by ``mode``).</span>
<span class="sd">        3. For each region, sample points uniformly in a cube of side length ``region_size`` around the center.</span>
<span class="sd">        4. Snap one coordinate of each region to one face of the bounding box, so that noise patches lie on or around the box surface.</span>
<span class="sd">        5. Generate random unit normals for these noise points.</span>
<span class="sd">        6. Optionally subsample a random subset of regions/points when ``fixed=False``.</span>
<span class="sd">        7. Concatenate noise coordinates, normals, and colors (if present) to the existing arrays, and update ``noise_index`` to mark them asbackground noise (label 2).</span>

<span class="sd">    Args:</span>
<span class="sd">        max_regions (int, optional):</span>
<span class="sd">            Maximum number of noise regions to generate. Each region is a local cube of sampled noise points.</span>
<span class="sd">            Defaults to 8.</span>
<span class="sd">        region_max_k (int, optional):</span>
<span class="sd">            Maximum number of points per region before optional subsampling. Total initial noise points are</span>
<span class="sd">            roughly ``max_regions * region_max_k`` before any reduction.</span>
<span class="sd">            Defaults to 128.</span>
<span class="sd">        region_size (float, optional):</span>
<span class="sd">            Side length of each cubic noise region. Points are sampled uniformly in a cube of side ``region_size``</span>
<span class="sd">            centered at each region center.</span>
<span class="sd">            Defaults to 0.5.</span>
<span class="sd">        fixed (bool, optional):</span>
<span class="sd">            Controls randomness and subsampling of the generated noise:</span>
<span class="sd">            * If ``False``:</span>
<span class="sd">              - Randomly choose a number of regions between 1 and ``max_regions``.</span>
<span class="sd">              - Flatten all noise points from those regions.</span>
<span class="sd">              - Randomly select a subset of points, with size between roughly 1/8 of all region points and the full set.</span>
<span class="sd">            * If ``True``:</span>
<span class="sd">              - Use all ``max_regions * region_max_k`` points (no region or point subsampling).</span>

<span class="sd">            Defaults to False.</span>
<span class="sd">        range255 (bool, optional):</span>
<span class="sd">            Whether color values are in the range ``[0, 255]``. If True, noise colors are sampled as integers in</span>
<span class="sd">            ``[0, 255]``. If False, noise colors are sampled as floats in ``[0, 1]``.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        mode ({&quot;outside&quot;, &quot;inside&quot;}, optional): Controls how the region</span>
<span class="sd">            centers are chosen relative to the bounding box:</span>

<span class="sd">            * ``&quot;inside&quot;``:</span>
<span class="sd">              - Region centers are chosen so that the entire noise cube (of side ``region_size``) lies strictly inside the bounding</span>
<span class="sd">                box, as much as possible. This ensures all noise points stay on/within the box volume.</span>
<span class="sd">            * ``&quot;outside&quot;``:</span>
<span class="sd">              - Region centers are sampled anywhere inside the bounding box, and one coordinate of each region is snapped to a box face.</span>
<span class="sd">                Some noise points may lie slightly outside the box, mimicking more realistic background clutter.</span>

<span class="sd">            Defaults to ``&quot;outside&quot;``.</span>
<span class="sd">        apply_p (float, optional):</span>
<span class="sd">            Probability of applying the background</span>
<span class="sd">            Defaults to 1.0.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_regions</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">region_max_k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">region_size</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">fixed</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">range255</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s2">&quot;outside&quot;</span><span class="p">,</span> <span class="n">apply_p</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span> <span class="o">=</span> <span class="n">max_regions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_max_k</span> <span class="o">=</span> <span class="n">region_max_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">=</span> <span class="n">region_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range255</span> <span class="o">=</span> <span class="n">range255</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span> <span class="o">=</span> <span class="n">apply_p</span>
        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;outside&quot;</span><span class="p">,</span> <span class="s2">&quot;inside&quot;</span><span class="p">]</span>
        <span class="c1"># &quot;inside&quot; is to make sure all noise are on the bounding box, &quot;outside&quot; only guarantee the center is on the</span>
        <span class="c1"># bounding box, some noise might be outside the box, &quot;inside&quot; is for nice for segmentation / denoising. But</span>
        <span class="c1"># &quot;outside&quot; is more like real background clutter.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add background noise regions and update aligned per-point attributes.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dict (dict): Input dictionary containing at least `&quot;coord&quot;`. May also contain `&quot;norm&quot;`, `&quot;color&quot;`, and `&quot;noise_index&quot;`.</span>
<span class="sd">                Any existing `&quot;noise_index&quot; &gt; 0` points are excluded when computing the bounding box used to place new regions.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The same dictionary with added background noise points (coords, normals, colors if present) and an updated</span>
<span class="sd">            `&quot;noise_index&quot;` marking these new points with label 2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
        <span class="n">max_value</span><span class="p">,</span> <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;inside&quot;</span><span class="p">:</span>
            <span class="n">span</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">min_value</span>
            <span class="n">inner_min</span> <span class="o">=</span> <span class="n">min_value</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
            <span class="n">inner_max</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inner_min</span> <span class="o">=</span> <span class="n">min_value</span>
            <span class="n">inner_max</span> <span class="o">=</span> <span class="n">max_value</span>

        <span class="n">random_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
        <span class="n">random_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
        <span class="n">random_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
        <span class="n">random_point_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">random_x</span><span class="p">,</span> <span class="n">random_y</span><span class="p">,</span> <span class="n">random_z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [max_regions, 3]</span>

        <span class="c1"># [max_regions, region_max_k, 3]</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">half</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_point_center</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_max_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point_center</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">noise</span>  <span class="c1"># [max_regions, 1, 3] + [max_regions, region_max_k, 3]</span>
        <span class="c1"># random_point_normal = np.zeros_like(random_point)  # [max_regions, region_max_k, 3]</span>
        <span class="c1"># tmp_normal = np.stack((np.eye(3), np.eye(3) * -1), axis=1)  # [3, 2, 3]</span>

        <span class="n">random_face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">random_face</span><span class="p">):</span>
            <span class="n">divide</span> <span class="o">=</span> <span class="n">val</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">val</span> <span class="o">%</span> <span class="mi">2</span>
            <span class="n">random_point</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">divide</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="n">divide</span><span class="p">][</span><span class="n">mod</span><span class="p">]</span>
            <span class="c1"># random_point_normal[i, :] = tmp_normal[divide][mod]</span>

        <span class="c1"># ----- RANDOM NORMALS INSTEAD OF FACE NORMALS -----</span>
        <span class="c1"># shape (R, K, 3)</span>
        <span class="n">rand_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># gaussian noise</span>
        <span class="c1"># normalize to unit vectors</span>
        <span class="n">norm_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rand_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">random_point_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_dir</span> <span class="o">/</span> <span class="n">norm_len</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">region_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="p">[:</span><span class="n">region_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="p">[:</span><span class="n">region_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">shuffle_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_idx</span><span class="p">)</span>
            <span class="n">shuffle_idx</span> <span class="o">=</span> <span class="n">shuffle_idx</span><span class="p">[:</span><span class="n">total_size</span><span class="p">]</span>
            <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="p">[</span><span class="n">shuffle_idx</span><span class="p">]</span>
            <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="p">[</span><span class="n">shuffle_idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># ----- ADD COLOR FOR NOISE -----</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">orig_color</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
            <span class="n">C</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
                <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># ----- CONCATENATE -----</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">random_point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">random_point_normal</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_color</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># ----- UPDATE noise_index -----</span>
        <span class="n">num_new</span> <span class="o">=</span> <span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">noise_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">noise_index</span><span class="p">[</span><span class="o">-</span><span class="n">num_new</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># mark new as noise</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
            <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">tmp</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

        <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="augmentation_class.AddBackgroundNoise.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Add background noise regions and update aligned per-point attributes.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary containing at least <code>"coord"</code>. May also contain <code>"norm"</code>, <code>"color"</code>, and <code>"noise_index"</code>.
Any existing <code>"noise_index" &gt; 0</code> points are excluded when computing the bounding box used to place new regions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The same dictionary with added background noise points (coords, normals, colors if present) and an updated</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>"noise_index"</code> marking these new points with label 2.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src\augmentation_class.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2542</span>
<span class="normal">2543</span>
<span class="normal">2544</span>
<span class="normal">2545</span>
<span class="normal">2546</span>
<span class="normal">2547</span>
<span class="normal">2548</span>
<span class="normal">2549</span>
<span class="normal">2550</span>
<span class="normal">2551</span>
<span class="normal">2552</span>
<span class="normal">2553</span>
<span class="normal">2554</span>
<span class="normal">2555</span>
<span class="normal">2556</span>
<span class="normal">2557</span>
<span class="normal">2558</span>
<span class="normal">2559</span>
<span class="normal">2560</span>
<span class="normal">2561</span>
<span class="normal">2562</span>
<span class="normal">2563</span>
<span class="normal">2564</span>
<span class="normal">2565</span>
<span class="normal">2566</span>
<span class="normal">2567</span>
<span class="normal">2568</span>
<span class="normal">2569</span>
<span class="normal">2570</span>
<span class="normal">2571</span>
<span class="normal">2572</span>
<span class="normal">2573</span>
<span class="normal">2574</span>
<span class="normal">2575</span>
<span class="normal">2576</span>
<span class="normal">2577</span>
<span class="normal">2578</span>
<span class="normal">2579</span>
<span class="normal">2580</span>
<span class="normal">2581</span>
<span class="normal">2582</span>
<span class="normal">2583</span>
<span class="normal">2584</span>
<span class="normal">2585</span>
<span class="normal">2586</span>
<span class="normal">2587</span>
<span class="normal">2588</span>
<span class="normal">2589</span>
<span class="normal">2590</span>
<span class="normal">2591</span>
<span class="normal">2592</span>
<span class="normal">2593</span>
<span class="normal">2594</span>
<span class="normal">2595</span>
<span class="normal">2596</span>
<span class="normal">2597</span>
<span class="normal">2598</span>
<span class="normal">2599</span>
<span class="normal">2600</span>
<span class="normal">2601</span>
<span class="normal">2602</span>
<span class="normal">2603</span>
<span class="normal">2604</span>
<span class="normal">2605</span>
<span class="normal">2606</span>
<span class="normal">2607</span>
<span class="normal">2608</span>
<span class="normal">2609</span>
<span class="normal">2610</span>
<span class="normal">2611</span>
<span class="normal">2612</span>
<span class="normal">2613</span>
<span class="normal">2614</span>
<span class="normal">2615</span>
<span class="normal">2616</span>
<span class="normal">2617</span>
<span class="normal">2618</span>
<span class="normal">2619</span>
<span class="normal">2620</span>
<span class="normal">2621</span>
<span class="normal">2622</span>
<span class="normal">2623</span>
<span class="normal">2624</span>
<span class="normal">2625</span>
<span class="normal">2626</span>
<span class="normal">2627</span>
<span class="normal">2628</span>
<span class="normal">2629</span>
<span class="normal">2630</span>
<span class="normal">2631</span>
<span class="normal">2632</span>
<span class="normal">2633</span>
<span class="normal">2634</span>
<span class="normal">2635</span>
<span class="normal">2636</span>
<span class="normal">2637</span>
<span class="normal">2638</span>
<span class="normal">2639</span>
<span class="normal">2640</span>
<span class="normal">2641</span>
<span class="normal">2642</span>
<span class="normal">2643</span>
<span class="normal">2644</span>
<span class="normal">2645</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add background noise regions and update aligned per-point attributes.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): Input dictionary containing at least `&quot;coord&quot;`. May also contain `&quot;norm&quot;`, `&quot;color&quot;`, and `&quot;noise_index&quot;`.</span>
<span class="sd">            Any existing `&quot;noise_index&quot; &gt; 0` points are excluded when computing the bounding box used to place new regions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The same dictionary with added background noise points (coords, normals, colors if present) and an updated</span>
<span class="sd">        `&quot;noise_index&quot;` marking these new points with label 2.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
    <span class="n">max_value</span><span class="p">,</span> <span class="n">min_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">coord</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bounding_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">min_value</span><span class="p">,</span> <span class="n">max_value</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">half</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_size</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;inside&quot;</span><span class="p">:</span>
        <span class="n">span</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">min_value</span>
        <span class="n">inner_min</span> <span class="o">=</span> <span class="n">min_value</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">inner_max</span> <span class="o">=</span> <span class="n">max_value</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">half</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">span</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inner_min</span> <span class="o">=</span> <span class="n">min_value</span>
        <span class="n">inner_max</span> <span class="o">=</span> <span class="n">max_value</span>

    <span class="n">random_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
    <span class="n">random_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
    <span class="n">random_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">inner_min</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">inner_max</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">)</span>  <span class="c1"># [max_regions]</span>
    <span class="n">random_point_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">((</span><span class="n">random_x</span><span class="p">,</span> <span class="n">random_y</span><span class="p">,</span> <span class="n">random_z</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># [max_regions, 3]</span>

    <span class="c1"># [max_regions, region_max_k, 3]</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="n">half</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">half</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_point_center</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">region_max_k</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point_center</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">noise</span>  <span class="c1"># [max_regions, 1, 3] + [max_regions, region_max_k, 3]</span>
    <span class="c1"># random_point_normal = np.zeros_like(random_point)  # [max_regions, region_max_k, 3]</span>
    <span class="c1"># tmp_normal = np.stack((np.eye(3), np.eye(3) * -1), axis=1)  # [3, 2, 3]</span>

    <span class="n">random_face</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">random_face</span><span class="p">):</span>
        <span class="n">divide</span> <span class="o">=</span> <span class="n">val</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">val</span> <span class="o">%</span> <span class="mi">2</span>
        <span class="n">random_point</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="n">divide</span><span class="p">]</span> <span class="o">=</span> <span class="n">bounding_box</span><span class="p">[</span><span class="n">divide</span><span class="p">][</span><span class="n">mod</span><span class="p">]</span>
        <span class="c1"># random_point_normal[i, :] = tmp_normal[divide][mod]</span>

    <span class="c1"># ----- RANDOM NORMALS INSTEAD OF FACE NORMALS -----</span>
    <span class="c1"># shape (R, K, 3)</span>
    <span class="n">rand_dir</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># gaussian noise</span>
    <span class="c1"># normalize to unit vectors</span>
    <span class="n">norm_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rand_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
    <span class="n">random_point_normal</span> <span class="o">=</span> <span class="p">(</span><span class="n">rand_dir</span> <span class="o">/</span> <span class="n">norm_len</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
        <span class="n">region_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_regions</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="p">[:</span><span class="n">region_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="p">[:</span><span class="n">region_size</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">total_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">shuffle_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_point</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffle_idx</span><span class="p">)</span>
        <span class="n">shuffle_idx</span> <span class="o">=</span> <span class="n">shuffle_idx</span><span class="p">[:</span><span class="n">total_size</span><span class="p">]</span>
        <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="p">[</span><span class="n">shuffle_idx</span><span class="p">]</span>
        <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="p">[</span><span class="n">shuffle_idx</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">random_point</span> <span class="o">=</span> <span class="n">random_point</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">random_point_normal</span> <span class="o">=</span> <span class="n">random_point_normal</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="c1"># ----- ADD COLOR FOR NOISE -----</span>
    <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">orig_color</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
            <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">noise_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">C</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># ----- CONCATENATE -----</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">random_point</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">random_point_normal</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_color</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ----- UPDATE noise_index -----</span>
    <span class="n">num_new</span> <span class="o">=</span> <span class="n">random_point</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">noise_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">noise_index</span><span class="p">[</span><span class="o">-</span><span class="n">num_new</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># mark new as noise</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">noise_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">tmp</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

    <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Adding Background Noise</strong></p>
<p align="center">
  <img src="../img/AddBackgroundNoise1.png" alt="Before" style="width:48%; max-width:48%; height:auto; margin-right:1%;">
  <img src="../img/AddBackgroundNoise2.png" alt="After" style="width:48%; max-width:48%; height:auto; margin-left:1%;">
</p>

<h2 id="addnoise">AddNoise</h2>


<div class="doc doc-object doc-class">




    <div class="doc doc-contents first">



        <p>Add local noise clusters around randomly chosen points.</p>
<p>This transform expects a dictionary containing:</p>
<ul>
<li><code>"coord"</code>: NumPy array of shape (N, 3) with point coordinates.</li>
<li>Optionally <code>"norm"</code>: per-point normals of shape (N, 3), required if
  <code>method="custom"</code>.</li>
<li>Optionally <code>"color"</code>: per-point colors of shape (N, C).</li>
<li>Optionally <code>"noise_index"</code>: 1D array of length N indicating existing noise labels.</li>
</ul>
<p>The transform works by:</p>
<ol>
<li>
<p>Selecting a subset of points as <strong>noise centers</strong>.
   The number of centers is:</p>
<p>noise_center_count = int(N * noise_size_ratio)</p>
</li>
</ol>
<p>(clamped to <code>[1, N]</code>). If this is 0, no noise is added.
2. For each center, generating up to <code>noise_max_k</code> noise points in its
   local neighborhood (cluster), according to the chosen <code>method</code> and <code>boundary</code>.
3. Optionally subsampling the generated noise when <code>fixed=False</code>.
4. Mapping the local offsets to world coordinates and appending them (and their normals/colors) to the existing arrays.
5. Updating <code>noise_index</code> to mark the new points as local noise (value 1).</p>
<p>Noise generation is controlled by two knobs:</p>
<ul>
<li><code>method</code>: defines <em>how</em> offsets are sampled:<ul>
<li><code>"uniform"</code>:</li>
<li>If <code>boundary="sphere"</code>: sample directions uniformly and radii uniformly in volume within a ball of radius <code>ball_r</code>.</li>
<li>If <code>boundary="cube"</code>: sample coordinates uniformly in <code>[low, high]^3</code>.</li>
<li><code>"gaussian"</code>:</li>
<li>If <code>boundary="sphere"</code>: Gaussian around the center, clamped to lie within a ball of radius <code>ball_r</code>.</li>
<li>If <code>boundary="cube"</code>: Gaussian in a cube, then clipped to the interval <code>[low, high]</code> per axis.</li>
<li><code>"custom"</code>:</li>
<li>Requires a <code>"norm"</code> field.</li>
<li>For each center, uses its normal as a base direction and applies directional + radial jitter (using <code>ball_r</code> as scale) to create
    offsets in a “tube-like” pattern around the surface.</li>
</ul>
</li>
<li><code>boundary</code>: defines the <em>shape</em> of the local region:<ul>
<li><code>"sphere"</code>: offsets lie in or near a ball of radius <code>ball_r</code>.</li>
<li><code>"cube"</code>: offsets lie in or near a cube with side approximately <code>high - low</code> (for uniform/gaussian).</li>
</ul>
</li>
</ul>
<p>Colors for noise points are derived from the center colors:</p>
<ul>
<li>For <code>"uniform"</code> and <code>"gaussian"</code> methods:</li>
<li>Noise points inherit exactly the color of their center.</li>
<li>For <code>"custom"</code>:</li>
<li>Optionally add Gaussian jitter in color space (scale depends on whether <code>range255</code> is True or False),
  then clip to valid range.</li>
</ul>
<p>The number of <strong>final</strong> noise points is controlled by <code>fixed</code>:</p>
<ul>
<li>If <code>fixed=True</code>:</li>
<li>Use all generated noise: <code>noise_center_count * noise_max_k</code> points.</li>
<li>If <code>fixed=False</code>:</li>
<li>Randomly shuffle all noise points and keep a random subset of size
    between approximately one-eighth and the full generated count.</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>noise_size_ratio</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fraction of non-noise points to use as noise centers. The number of centers is:</p>
<pre><code>noise_center_count = int(N * noise_size_ratio)
</code></pre>
<p>Defaults to 1./64.</p>
              </div>
            </td>
            <td>
                  <code>1.0 / 64</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>noise_max_k</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Maximum number of noise points generated per center before optional subsampling.
Defaults to 16.</p>
              </div>
            </td>
            <td>
                  <code>16</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fixed</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether to keep all generated noise points or randomly subsample them:</p>
<ul>
<li>True  → keep all <code>noise_center_count * noise_max_k</code> noise points.</li>
<li>False → shuffle and randomly keep a subset of those points.</li>
</ul>
<p>Defaults to True.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>method</code>
            </td>
            <td>
                  <code>{<span title="uniform">uniform</span>, <span title="gaussian">gaussian</span>, <span title="custom">custom</span>}</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Noise sampling strategy. See above for details. <code>"custom"</code> requires
<code>"norm"</code> in <code>data_dict</code>.
Defaults to <code>"uniform"</code>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;uniform&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>boundary</code>
            </td>
            <td>
                  <code>{<span title="sphere">sphere</span>, <span title="cube">cube</span>}</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Shape of the local region in which noise is sampled. Interacts with <code>method</code> as described above.
Defaults to <code>"sphere"</code>.</p>
              </div>
            </td>
            <td>
                  <code>&#39;sphere&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>low</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Lower bound for cube-based offsets (used for <code>boundary="cube"</code> in <code>"uniform"</code> and <code>"gaussian"</code>).
Defaults to -0.1.</p>
              </div>
            </td>
            <td>
                  <code>-0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>high</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Upper bound for cube-based offsets.
Defaults to 0.1.</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ball_r</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Radius of the spherical neighborhood for <code>boundary="sphere"</code> methods; also used as a scale for radial
jitter in the <code>"custom"</code> method.
Defaults to 0.1.</p>
              </div>
            </td>
            <td>
                  <code>0.1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>range255</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Whether colors are stored in <code>[0, 255]</code> (integer-like). If True, color jitter in the <code>"custom"</code> method
is done in that range. If False, colors are assumed in <code>[0, 1]</code>.
Defaults to False.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>apply_p</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Probability of applying the noise
Defaults to 1.0.</p>
              </div>
            </td>
            <td>
                  <code>1.0</code>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>src\augmentation_class.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2647</span>
<span class="normal">2648</span>
<span class="normal">2649</span>
<span class="normal">2650</span>
<span class="normal">2651</span>
<span class="normal">2652</span>
<span class="normal">2653</span>
<span class="normal">2654</span>
<span class="normal">2655</span>
<span class="normal">2656</span>
<span class="normal">2657</span>
<span class="normal">2658</span>
<span class="normal">2659</span>
<span class="normal">2660</span>
<span class="normal">2661</span>
<span class="normal">2662</span>
<span class="normal">2663</span>
<span class="normal">2664</span>
<span class="normal">2665</span>
<span class="normal">2666</span>
<span class="normal">2667</span>
<span class="normal">2668</span>
<span class="normal">2669</span>
<span class="normal">2670</span>
<span class="normal">2671</span>
<span class="normal">2672</span>
<span class="normal">2673</span>
<span class="normal">2674</span>
<span class="normal">2675</span>
<span class="normal">2676</span>
<span class="normal">2677</span>
<span class="normal">2678</span>
<span class="normal">2679</span>
<span class="normal">2680</span>
<span class="normal">2681</span>
<span class="normal">2682</span>
<span class="normal">2683</span>
<span class="normal">2684</span>
<span class="normal">2685</span>
<span class="normal">2686</span>
<span class="normal">2687</span>
<span class="normal">2688</span>
<span class="normal">2689</span>
<span class="normal">2690</span>
<span class="normal">2691</span>
<span class="normal">2692</span>
<span class="normal">2693</span>
<span class="normal">2694</span>
<span class="normal">2695</span>
<span class="normal">2696</span>
<span class="normal">2697</span>
<span class="normal">2698</span>
<span class="normal">2699</span>
<span class="normal">2700</span>
<span class="normal">2701</span>
<span class="normal">2702</span>
<span class="normal">2703</span>
<span class="normal">2704</span>
<span class="normal">2705</span>
<span class="normal">2706</span>
<span class="normal">2707</span>
<span class="normal">2708</span>
<span class="normal">2709</span>
<span class="normal">2710</span>
<span class="normal">2711</span>
<span class="normal">2712</span>
<span class="normal">2713</span>
<span class="normal">2714</span>
<span class="normal">2715</span>
<span class="normal">2716</span>
<span class="normal">2717</span>
<span class="normal">2718</span>
<span class="normal">2719</span>
<span class="normal">2720</span>
<span class="normal">2721</span>
<span class="normal">2722</span>
<span class="normal">2723</span>
<span class="normal">2724</span>
<span class="normal">2725</span>
<span class="normal">2726</span>
<span class="normal">2727</span>
<span class="normal">2728</span>
<span class="normal">2729</span>
<span class="normal">2730</span>
<span class="normal">2731</span>
<span class="normal">2732</span>
<span class="normal">2733</span>
<span class="normal">2734</span>
<span class="normal">2735</span>
<span class="normal">2736</span>
<span class="normal">2737</span>
<span class="normal">2738</span>
<span class="normal">2739</span>
<span class="normal">2740</span>
<span class="normal">2741</span>
<span class="normal">2742</span>
<span class="normal">2743</span>
<span class="normal">2744</span>
<span class="normal">2745</span>
<span class="normal">2746</span>
<span class="normal">2747</span>
<span class="normal">2748</span>
<span class="normal">2749</span>
<span class="normal">2750</span>
<span class="normal">2751</span>
<span class="normal">2752</span>
<span class="normal">2753</span>
<span class="normal">2754</span>
<span class="normal">2755</span>
<span class="normal">2756</span>
<span class="normal">2757</span>
<span class="normal">2758</span>
<span class="normal">2759</span>
<span class="normal">2760</span>
<span class="normal">2761</span>
<span class="normal">2762</span>
<span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@TRANSFORMS</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AddNoise</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add local noise clusters around randomly chosen points.</span>

<span class="sd">    This transform expects a dictionary containing:</span>

<span class="sd">    * ``&quot;coord&quot;``: NumPy array of shape (N, 3) with point coordinates.</span>
<span class="sd">    * Optionally ``&quot;norm&quot;``: per-point normals of shape (N, 3), required if</span>
<span class="sd">      ``method=&quot;custom&quot;``.</span>
<span class="sd">    * Optionally ``&quot;color&quot;``: per-point colors of shape (N, C).</span>
<span class="sd">    * Optionally ``&quot;noise_index&quot;``: 1D array of length N indicating existing noise labels.</span>

<span class="sd">    The transform works by:</span>

<span class="sd">    1. Selecting a subset of points as **noise centers**.</span>
<span class="sd">       The number of centers is:</span>

<span class="sd">           noise_center_count = int(N * noise_size_ratio)</span>

<span class="sd">       (clamped to ``[1, N]``). If this is 0, no noise is added.</span>
<span class="sd">    2. For each center, generating up to ``noise_max_k`` noise points in its</span>
<span class="sd">       local neighborhood (cluster), according to the chosen ``method`` and ``boundary``.</span>
<span class="sd">    3. Optionally subsampling the generated noise when ``fixed=False``.</span>
<span class="sd">    4. Mapping the local offsets to world coordinates and appending them (and their normals/colors) to the existing arrays.</span>
<span class="sd">    5. Updating ``noise_index`` to mark the new points as local noise (value 1).</span>

<span class="sd">    Noise generation is controlled by two knobs:</span>

<span class="sd">    * ``method``: defines *how* offsets are sampled:</span>
<span class="sd">        - ``&quot;uniform&quot;``:</span>
<span class="sd">          * If ``boundary=&quot;sphere&quot;``: sample directions uniformly and radii uniformly in volume within a ball of radius ``ball_r``.</span>
<span class="sd">          * If ``boundary=&quot;cube&quot;``: sample coordinates uniformly in ``[low, high]^3``.</span>
<span class="sd">        - ``&quot;gaussian&quot;``:</span>
<span class="sd">          * If ``boundary=&quot;sphere&quot;``: Gaussian around the center, clamped to lie within a ball of radius ``ball_r``.</span>
<span class="sd">          * If ``boundary=&quot;cube&quot;``: Gaussian in a cube, then clipped to the interval ``[low, high]`` per axis.</span>
<span class="sd">        - ``&quot;custom&quot;``:</span>
<span class="sd">          * Requires a ``&quot;norm&quot;`` field.</span>
<span class="sd">          * For each center, uses its normal as a base direction and applies directional + radial jitter (using ``ball_r`` as scale) to create</span>
<span class="sd">            offsets in a “tube-like” pattern around the surface.</span>
<span class="sd">    * ``boundary``: defines the *shape* of the local region:</span>
<span class="sd">        - ``&quot;sphere&quot;``: offsets lie in or near a ball of radius ``ball_r``.</span>
<span class="sd">        - ``&quot;cube&quot;``: offsets lie in or near a cube with side approximately ``high - low`` (for uniform/gaussian).</span>

<span class="sd">    Colors for noise points are derived from the center colors:</span>

<span class="sd">    * For ``&quot;uniform&quot;`` and ``&quot;gaussian&quot;`` methods:</span>
<span class="sd">      - Noise points inherit exactly the color of their center.</span>
<span class="sd">    * For ``&quot;custom&quot;``:</span>
<span class="sd">      - Optionally add Gaussian jitter in color space (scale depends on whether ``range255`` is True or False),</span>
<span class="sd">      then clip to valid range.</span>

<span class="sd">    The number of **final** noise points is controlled by ``fixed``:</span>

<span class="sd">    * If ``fixed=True``:</span>
<span class="sd">      - Use all generated noise: ``noise_center_count * noise_max_k`` points.</span>
<span class="sd">    * If ``fixed=False``:</span>
<span class="sd">      - Randomly shuffle all noise points and keep a random subset of size</span>
<span class="sd">        between approximately one-eighth and the full generated count.</span>

<span class="sd">    Args:</span>
<span class="sd">        noise_size_ratio (float, optional):</span>
<span class="sd">            Fraction of non-noise points to use as noise centers. The number of centers is:</span>

<span class="sd">                noise_center_count = int(N * noise_size_ratio)</span>

<span class="sd">            Defaults to 1./64.</span>
<span class="sd">        noise_max_k (int, optional):</span>
<span class="sd">            Maximum number of noise points generated per center before optional subsampling.</span>
<span class="sd">            Defaults to 16.</span>
<span class="sd">        fixed (bool, optional):</span>
<span class="sd">            Whether to keep all generated noise points or randomly subsample them:</span>

<span class="sd">            * True  → keep all ``noise_center_count * noise_max_k`` noise points.</span>
<span class="sd">            * False → shuffle and randomly keep a subset of those points.</span>

<span class="sd">            Defaults to True.</span>
<span class="sd">        method ({&quot;uniform&quot;, &quot;gaussian&quot;, &quot;custom&quot;}, optional):</span>
<span class="sd">            Noise sampling strategy. See above for details. ``&quot;custom&quot;`` requires</span>
<span class="sd">            ``&quot;norm&quot;`` in ``data_dict``.</span>
<span class="sd">            Defaults to ``&quot;uniform&quot;``.</span>
<span class="sd">        boundary ({&quot;sphere&quot;, &quot;cube&quot;}, optional):</span>
<span class="sd">            Shape of the local region in which noise is sampled. Interacts with ``method`` as described above.</span>
<span class="sd">            Defaults to ``&quot;sphere&quot;``.</span>
<span class="sd">        low (float, optional):</span>
<span class="sd">            Lower bound for cube-based offsets (used for ``boundary=&quot;cube&quot;`` in ``&quot;uniform&quot;`` and ``&quot;gaussian&quot;``).</span>
<span class="sd">            Defaults to -0.1.</span>
<span class="sd">        high (float, optional):</span>
<span class="sd">            Upper bound for cube-based offsets.</span>
<span class="sd">            Defaults to 0.1.</span>
<span class="sd">        ball_r (float, optional):</span>
<span class="sd">            Radius of the spherical neighborhood for ``boundary=&quot;sphere&quot;`` methods; also used as a scale for radial</span>
<span class="sd">            jitter in the ``&quot;custom&quot;`` method.</span>
<span class="sd">            Defaults to 0.1.</span>
<span class="sd">        range255 (bool, optional):</span>
<span class="sd">            Whether colors are stored in ``[0, 255]`` (integer-like). If True, color jitter in the ``&quot;custom&quot;`` method</span>
<span class="sd">            is done in that range. If False, colors are assumed in ``[0, 1]``.</span>
<span class="sd">            Defaults to False.</span>
<span class="sd">        apply_p (float, optional):</span>
<span class="sd">            Probability of applying the noise</span>
<span class="sd">            Defaults to 1.0.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise_size_ratio</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="mi">64</span><span class="p">,</span> <span class="n">noise_max_k</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">fixed</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="n">boundary</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span>
                 <span class="n">low</span><span class="p">:</span><span class="nb">float</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">high</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ball_r</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">range255</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">apply_p</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_size_ratio</span> <span class="o">=</span> <span class="n">noise_size_ratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noise_max_k</span> <span class="o">=</span> <span class="n">noise_max_k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>
        <span class="k">assert</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">,</span> <span class="s2">&quot;custom&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="k">assert</span> <span class="n">boundary</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;sphere&quot;</span><span class="p">,</span> <span class="s2">&quot;cube&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">=</span> <span class="n">boundary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">=</span> <span class="n">ball_r</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">range255</span> <span class="o">=</span> <span class="n">range255</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span> <span class="o">=</span> <span class="n">apply_p</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply local noise cluster augmentation to a point cloud dictionary.</span>

<span class="sd">        Args:</span>
<span class="sd">            data_dict (dict): Input dictionary containing at least ``&quot;coord&quot;`` (NumPy array of shape (N, 3)).</span>
<span class="sd">                May also contain ``&quot;norm&quot;``, ``&quot;color&quot;``, and ``&quot;noise_index&quot;``. For ``method=&quot;custom&quot;``, ``&quot;norm&quot;`` must be present.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: The same dictionary with additional noise points appended to the relevant per-point fields and an updated ``&quot;noise_index&quot;`` marking newly added noise points with label 1.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>
        <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># how many centers</span>
        <span class="n">noise_center_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_size_ratio</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noise_center_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>
        <span class="n">noise_center_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">noise_center_count</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="c1"># choose centers</span>
        <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">noise_center_count</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (C, 3)</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">noise_center_count</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_max_k</span>

        <span class="c1"># ----------------- generate offsets (noise in local coords) -----------------</span>
        <span class="n">noise_offsets</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (C, K, 3)</span>
        <span class="n">noise_normals</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (C, K, 3) or None</span>

        <span class="c1"># helper: random unit directions</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">random_unit_vectors</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
            <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">norm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;sphere&quot;</span><span class="p">:</span>
                <span class="c1"># uniform in ball of radius ball_r</span>
                <span class="n">dirs</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span>  <span class="c1"># uniform in volume</span>
                <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">dirs</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">dirs</span>  <span class="c1"># can use direction as &quot;normal&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span>
                <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;sphere&quot;</span><span class="p">:</span>
                <span class="c1"># sample Gaussian around center</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="c1"># radii of those offsets</span>
                <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>  <span class="c1"># (C, K, 1)</span>
                <span class="c1"># clamp radius to ball_r by scaling each vector</span>
                <span class="c1"># scale = 1 if inside, ball_r / r if outside</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="n">radii</span><span class="p">)</span>  <span class="c1"># (C, K, 1), broadcasts over last dim</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">*</span> <span class="n">scale</span>  <span class="c1"># (C, K, 3)</span>
                <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">offsets</span>
                <span class="c1"># recompute or reuse direction as normals</span>
                <span class="n">new_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
                <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">/</span> <span class="n">new_radii</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span>
                <span class="c1"># Gaussian in a cube, then clipped to [low, high]</span>
                <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>  <span class="c1"># ~99.7% in [low, high]</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
                <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
                <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">offsets</span>
                <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">assert</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">,</span> <span class="s2">&quot;custom method requires &#39;norm&#39; in data_dict.&quot;</span>

            <span class="n">noise_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>  <span class="c1"># N&#39; centers</span>
            <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_max_k</span>

            <span class="c1"># ---- center normals ----</span>
            <span class="n">normal_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (N&#39;, 3)</span>
            <span class="c1"># make sure they are unit vectors</span>
            <span class="n">normal_centers</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal_centers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

            <span class="c1"># [N&#39;, K, 3] repeat normals per patch</span>
            <span class="n">repeat_normals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">normal_centers</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N&#39;, K, 3)</span>

            <span class="c1"># =====================================================</span>
            <span class="c1"># 1) JITTER FOR NORMAL DIRECTION (directional jitter)</span>
            <span class="c1"># =====================================================</span>
            <span class="c1"># small Gaussian noise added to the normal, then renormalized</span>
            <span class="n">dir_sigma</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># strength of direction jitter (tune if needed)</span>
            <span class="n">dir_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">dir_sigma</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="n">perturbed_dir</span> <span class="o">=</span> <span class="n">repeat_normals</span> <span class="o">+</span> <span class="n">dir_jitter</span>  <span class="c1"># (N&#39;, K, 3)</span>
            <span class="n">dir_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perturbed_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
            <span class="n">dir_unit</span> <span class="o">=</span> <span class="n">perturbed_dir</span> <span class="o">/</span> <span class="n">dir_norm</span>  <span class="c1"># (N&#39;, K, 3), unit direction per noise point</span>

            <span class="c1"># =====================================================</span>
            <span class="c1"># 2) JITTER FOR DISTANCE TO CENTER (radial jitter)</span>
            <span class="c1"># =====================================================</span>
            <span class="c1"># base radius in [0, ball_r], biased toward outer region (your original idea)</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>  <span class="c1"># (N&#39;, K)</span>
            <span class="n">base_radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span>  <span class="c1"># (N&#39;, K), &gt;= 0</span>

            <span class="c1"># additive jitter around base_radius</span>
            <span class="n">dist_sigma</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># in *absolute* units of ball_r (tune this)</span>
            <span class="n">jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
                <span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="n">dist_sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span><span class="p">,</span>
                <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
            <span class="p">)</span>  <span class="c1"># (N&#39;, K)</span>

            <span class="n">r</span> <span class="o">=</span> <span class="n">base_radius</span> <span class="o">+</span> <span class="n">jitter</span>  <span class="c1"># (N&#39;, K)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span><span class="p">)</span>  <span class="c1"># keep in [0, ball_r]</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (N&#39;, K, 1)</span>

            <span class="c1"># =====================================================</span>
            <span class="c1"># FINAL OFFSETS &amp; NORMALS (LOCAL COORDS)</span>
            <span class="c1"># =====================================================</span>
            <span class="c1"># offset from center = jittered direction * jittered distance</span>
            <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">dir_unit</span> <span class="o">*</span> <span class="n">r</span>  <span class="c1"># (N&#39;, K, 3)</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">dir_unit</span>  <span class="c1"># (N&#39;, K, 3)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">data_dict</span>

        <span class="c1"># ----------------- COLOR: center-based -----------------</span>
        <span class="n">noise_colors</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">orig_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
            <span class="n">center_colors</span> <span class="o">=</span> <span class="n">orig_color</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (C, Cc)</span>
            <span class="n">base_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">center_colors</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (C, K, Cc)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>
                <span class="c1"># exactly same color as center</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
                    <span class="n">color_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">base_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span> <span class="o">+</span> <span class="n">color_jitter</span>
                    <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">noise_colors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">color_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">base_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                    <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span> <span class="o">+</span> <span class="n">color_jitter</span>
                    <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">noise_colors</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># ----------------- map to world coords -----------------</span>
        <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_offsets</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (C, K, 3)</span>

        <span class="c1"># flatten</span>
        <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">noise_normals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">noise_colors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># ----------------- optional subsampling -----------------</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">))</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">total</span><span class="p">]</span>

            <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">noise_normals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">noise_colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="c1"># ----------------- append to data_dict -----------------</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">noise_points</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">noise_normals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_colors</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># ----------------- noise_index -----------------</span>
        <span class="n">num_noise</span> <span class="o">=</span> <span class="n">noise_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
            <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">ni</span><span class="p">[</span><span class="o">-</span><span class="n">num_noise</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
            <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
            <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
            <span class="n">ni</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>

        <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="augmentation_class.AddNoise.__call__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__call__</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Apply local noise cluster augmentation to a point cloud dictionary.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data_dict</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input dictionary containing at least <code>"coord"</code> (NumPy array of shape (N, 3)).
May also contain <code>"norm"</code>, <code>"color"</code>, and <code>"noise_index"</code>. For <code>method="custom"</code>, <code>"norm"</code> must be present.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>dict</code></td>            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The same dictionary with additional noise points appended to the relevant per-point fields and an updated <code>"noise_index"</code> marking newly added noise points with label 1.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>src\augmentation_class.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">2763</span>
<span class="normal">2764</span>
<span class="normal">2765</span>
<span class="normal">2766</span>
<span class="normal">2767</span>
<span class="normal">2768</span>
<span class="normal">2769</span>
<span class="normal">2770</span>
<span class="normal">2771</span>
<span class="normal">2772</span>
<span class="normal">2773</span>
<span class="normal">2774</span>
<span class="normal">2775</span>
<span class="normal">2776</span>
<span class="normal">2777</span>
<span class="normal">2778</span>
<span class="normal">2779</span>
<span class="normal">2780</span>
<span class="normal">2781</span>
<span class="normal">2782</span>
<span class="normal">2783</span>
<span class="normal">2784</span>
<span class="normal">2785</span>
<span class="normal">2786</span>
<span class="normal">2787</span>
<span class="normal">2788</span>
<span class="normal">2789</span>
<span class="normal">2790</span>
<span class="normal">2791</span>
<span class="normal">2792</span>
<span class="normal">2793</span>
<span class="normal">2794</span>
<span class="normal">2795</span>
<span class="normal">2796</span>
<span class="normal">2797</span>
<span class="normal">2798</span>
<span class="normal">2799</span>
<span class="normal">2800</span>
<span class="normal">2801</span>
<span class="normal">2802</span>
<span class="normal">2803</span>
<span class="normal">2804</span>
<span class="normal">2805</span>
<span class="normal">2806</span>
<span class="normal">2807</span>
<span class="normal">2808</span>
<span class="normal">2809</span>
<span class="normal">2810</span>
<span class="normal">2811</span>
<span class="normal">2812</span>
<span class="normal">2813</span>
<span class="normal">2814</span>
<span class="normal">2815</span>
<span class="normal">2816</span>
<span class="normal">2817</span>
<span class="normal">2818</span>
<span class="normal">2819</span>
<span class="normal">2820</span>
<span class="normal">2821</span>
<span class="normal">2822</span>
<span class="normal">2823</span>
<span class="normal">2824</span>
<span class="normal">2825</span>
<span class="normal">2826</span>
<span class="normal">2827</span>
<span class="normal">2828</span>
<span class="normal">2829</span>
<span class="normal">2830</span>
<span class="normal">2831</span>
<span class="normal">2832</span>
<span class="normal">2833</span>
<span class="normal">2834</span>
<span class="normal">2835</span>
<span class="normal">2836</span>
<span class="normal">2837</span>
<span class="normal">2838</span>
<span class="normal">2839</span>
<span class="normal">2840</span>
<span class="normal">2841</span>
<span class="normal">2842</span>
<span class="normal">2843</span>
<span class="normal">2844</span>
<span class="normal">2845</span>
<span class="normal">2846</span>
<span class="normal">2847</span>
<span class="normal">2848</span>
<span class="normal">2849</span>
<span class="normal">2850</span>
<span class="normal">2851</span>
<span class="normal">2852</span>
<span class="normal">2853</span>
<span class="normal">2854</span>
<span class="normal">2855</span>
<span class="normal">2856</span>
<span class="normal">2857</span>
<span class="normal">2858</span>
<span class="normal">2859</span>
<span class="normal">2860</span>
<span class="normal">2861</span>
<span class="normal">2862</span>
<span class="normal">2863</span>
<span class="normal">2864</span>
<span class="normal">2865</span>
<span class="normal">2866</span>
<span class="normal">2867</span>
<span class="normal">2868</span>
<span class="normal">2869</span>
<span class="normal">2870</span>
<span class="normal">2871</span>
<span class="normal">2872</span>
<span class="normal">2873</span>
<span class="normal">2874</span>
<span class="normal">2875</span>
<span class="normal">2876</span>
<span class="normal">2877</span>
<span class="normal">2878</span>
<span class="normal">2879</span>
<span class="normal">2880</span>
<span class="normal">2881</span>
<span class="normal">2882</span>
<span class="normal">2883</span>
<span class="normal">2884</span>
<span class="normal">2885</span>
<span class="normal">2886</span>
<span class="normal">2887</span>
<span class="normal">2888</span>
<span class="normal">2889</span>
<span class="normal">2890</span>
<span class="normal">2891</span>
<span class="normal">2892</span>
<span class="normal">2893</span>
<span class="normal">2894</span>
<span class="normal">2895</span>
<span class="normal">2896</span>
<span class="normal">2897</span>
<span class="normal">2898</span>
<span class="normal">2899</span>
<span class="normal">2900</span>
<span class="normal">2901</span>
<span class="normal">2902</span>
<span class="normal">2903</span>
<span class="normal">2904</span>
<span class="normal">2905</span>
<span class="normal">2906</span>
<span class="normal">2907</span>
<span class="normal">2908</span>
<span class="normal">2909</span>
<span class="normal">2910</span>
<span class="normal">2911</span>
<span class="normal">2912</span>
<span class="normal">2913</span>
<span class="normal">2914</span>
<span class="normal">2915</span>
<span class="normal">2916</span>
<span class="normal">2917</span>
<span class="normal">2918</span>
<span class="normal">2919</span>
<span class="normal">2920</span>
<span class="normal">2921</span>
<span class="normal">2922</span>
<span class="normal">2923</span>
<span class="normal">2924</span>
<span class="normal">2925</span>
<span class="normal">2926</span>
<span class="normal">2927</span>
<span class="normal">2928</span>
<span class="normal">2929</span>
<span class="normal">2930</span>
<span class="normal">2931</span>
<span class="normal">2932</span>
<span class="normal">2933</span>
<span class="normal">2934</span>
<span class="normal">2935</span>
<span class="normal">2936</span>
<span class="normal">2937</span>
<span class="normal">2938</span>
<span class="normal">2939</span>
<span class="normal">2940</span>
<span class="normal">2941</span>
<span class="normal">2942</span>
<span class="normal">2943</span>
<span class="normal">2944</span>
<span class="normal">2945</span>
<span class="normal">2946</span>
<span class="normal">2947</span>
<span class="normal">2948</span>
<span class="normal">2949</span>
<span class="normal">2950</span>
<span class="normal">2951</span>
<span class="normal">2952</span>
<span class="normal">2953</span>
<span class="normal">2954</span>
<span class="normal">2955</span>
<span class="normal">2956</span>
<span class="normal">2957</span>
<span class="normal">2958</span>
<span class="normal">2959</span>
<span class="normal">2960</span>
<span class="normal">2961</span>
<span class="normal">2962</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply local noise cluster augmentation to a point cloud dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_dict (dict): Input dictionary containing at least ``&quot;coord&quot;`` (NumPy array of shape (N, 3)).</span>
<span class="sd">            May also contain ``&quot;norm&quot;``, ``&quot;color&quot;``, and ``&quot;noise_index&quot;``. For ``method=&quot;custom&quot;``, ``&quot;norm&quot;`` must be present.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The same dictionary with additional noise points appended to the relevant per-point fields and an updated ``&quot;noise_index&quot;`` marking newly added noise points with label 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_p</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>
    <span class="k">if</span> <span class="s2">&quot;coord&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="n">coord</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">coord</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># how many centers</span>
    <span class="n">noise_center_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_size_ratio</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise_center_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>
    <span class="n">noise_center_count</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">noise_center_count</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

    <span class="c1"># choose centers</span>
    <span class="n">center_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">noise_center_count</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">coord</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (C, 3)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">noise_center_count</span>
    <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_max_k</span>

    <span class="c1"># ----------------- generate offsets (noise in local coords) -----------------</span>
    <span class="n">noise_offsets</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (C, K, 3)</span>
    <span class="n">noise_normals</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># (C, K, 3) or None</span>

    <span class="c1"># helper: random unit directions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">random_unit_vectors</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">norm</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;uniform&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;sphere&quot;</span><span class="p">:</span>
            <span class="c1"># uniform in ball of radius ball_r</span>
            <span class="n">dirs</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span>  <span class="c1"># uniform in volume</span>
            <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">dirs</span> <span class="o">*</span> <span class="n">radii</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">dirs</span>  <span class="c1"># can use direction as &quot;normal&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span>
            <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;sphere&quot;</span><span class="p">:</span>
            <span class="c1"># sample Gaussian around center</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="c1"># radii of those offsets</span>
            <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>  <span class="c1"># (C, K, 1)</span>
            <span class="c1"># clamp radius to ball_r by scaling each vector</span>
            <span class="c1"># scale = 1 if inside, ball_r / r if outside</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="n">radii</span><span class="p">)</span>  <span class="c1"># (C, K, 1), broadcasts over last dim</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">*</span> <span class="n">scale</span>  <span class="c1"># (C, K, 3)</span>
            <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">offsets</span>
            <span class="c1"># recompute or reuse direction as normals</span>
            <span class="n">new_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">offsets</span> <span class="o">/</span> <span class="n">new_radii</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary</span> <span class="o">==</span> <span class="s2">&quot;cube&quot;</span><span class="p">:</span>
            <span class="c1"># Gaussian in a cube, then clipped to [low, high]</span>
            <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">high</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">)</span> <span class="o">/</span> <span class="mf">6.0</span>  <span class="c1"># ~99.7% in [low, high]</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
            <span class="n">offsets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">offsets</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">low</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">high</span><span class="p">)</span>
            <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">offsets</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">random_unit_vectors</span><span class="p">((</span><span class="n">C</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
        <span class="k">assert</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">,</span> <span class="s2">&quot;custom method requires &#39;norm&#39; in data_dict.&quot;</span>

        <span class="n">noise_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">center_idx</span><span class="p">)</span>  <span class="c1"># N&#39; centers</span>
        <span class="n">K</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">noise_max_k</span>

        <span class="c1"># ---- center normals ----</span>
        <span class="n">normal_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (N&#39;, 3)</span>
        <span class="c1"># make sure they are unit vectors</span>
        <span class="n">normal_centers</span> <span class="o">/=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">normal_centers</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span><span class="p">)</span>

        <span class="c1"># [N&#39;, K, 3] repeat normals per patch</span>
        <span class="n">repeat_normals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">normal_centers</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (N&#39;, K, 3)</span>

        <span class="c1"># =====================================================</span>
        <span class="c1"># 1) JITTER FOR NORMAL DIRECTION (directional jitter)</span>
        <span class="c1"># =====================================================</span>
        <span class="c1"># small Gaussian noise added to the normal, then renormalized</span>
        <span class="n">dir_sigma</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># strength of direction jitter (tune if needed)</span>
        <span class="n">dir_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">dir_sigma</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">perturbed_dir</span> <span class="o">=</span> <span class="n">repeat_normals</span> <span class="o">+</span> <span class="n">dir_jitter</span>  <span class="c1"># (N&#39;, K, 3)</span>
        <span class="n">dir_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perturbed_dir</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-8</span>
        <span class="n">dir_unit</span> <span class="o">=</span> <span class="n">perturbed_dir</span> <span class="o">/</span> <span class="n">dir_norm</span>  <span class="c1"># (N&#39;, K, 3), unit direction per noise point</span>

        <span class="c1"># =====================================================</span>
        <span class="c1"># 2) JITTER FOR DISTANCE TO CENTER (radial jitter)</span>
        <span class="c1"># =====================================================</span>
        <span class="c1"># base radius in [0, ball_r], biased toward outer region (your original idea)</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>  <span class="c1"># (N&#39;, K)</span>
        <span class="n">base_radius</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">**</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span>  <span class="c1"># (N&#39;, K), &gt;= 0</span>

        <span class="c1"># additive jitter around base_radius</span>
        <span class="n">dist_sigma</span> <span class="o">=</span> <span class="mf">1.</span>  <span class="c1"># in *absolute* units of ball_r (tune this)</span>
        <span class="n">jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span>
            <span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
            <span class="n">scale</span><span class="o">=</span><span class="n">dist_sigma</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">noise_size</span><span class="p">,</span> <span class="n">K</span><span class="p">)</span>
        <span class="p">)</span>  <span class="c1"># (N&#39;, K)</span>

        <span class="n">r</span> <span class="o">=</span> <span class="n">base_radius</span> <span class="o">+</span> <span class="n">jitter</span>  <span class="c1"># (N&#39;, K)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ball_r</span><span class="p">)</span>  <span class="c1"># keep in [0, ball_r]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="c1"># (N&#39;, K, 1)</span>

        <span class="c1"># =====================================================</span>
        <span class="c1"># FINAL OFFSETS &amp; NORMALS (LOCAL COORDS)</span>
        <span class="c1"># =====================================================</span>
        <span class="c1"># offset from center = jittered direction * jittered distance</span>
        <span class="n">noise_offsets</span> <span class="o">=</span> <span class="n">dir_unit</span> <span class="o">*</span> <span class="n">r</span>  <span class="c1"># (N&#39;, K, 3)</span>
        <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">dir_unit</span>  <span class="c1"># (N&#39;, K, 3)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data_dict</span>

    <span class="c1"># ----------------- COLOR: center-based -----------------</span>
    <span class="n">noise_colors</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">orig_color</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">])</span>
        <span class="n">center_colors</span> <span class="o">=</span> <span class="n">orig_color</span><span class="p">[</span><span class="n">center_idx</span><span class="p">]</span>  <span class="c1"># (C, Cc)</span>
        <span class="n">base_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">center_colors</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="n">K</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (C, K, Cc)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;uniform&quot;</span><span class="p">,</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">):</span>
            <span class="c1"># exactly same color as center</span>
            <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">range255</span><span class="p">:</span>
                <span class="n">color_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">base_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span> <span class="o">+</span> <span class="n">color_jitter</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">noise_colors</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">color_jitter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">base_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">base_colors</span> <span class="o">+</span> <span class="n">color_jitter</span>
                <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">noise_colors</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">orig_color</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># ----------------- map to world coords -----------------</span>
    <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_offsets</span> <span class="o">+</span> <span class="n">centers</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>  <span class="c1"># (C, K, 3)</span>

    <span class="c1"># flatten</span>
    <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">noise_normals</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">noise_colors</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">noise_colors</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># ----------------- optional subsampling -----------------</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">:</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_points</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[:</span><span class="n">total</span><span class="p">]</span>

        <span class="n">noise_points</span> <span class="o">=</span> <span class="n">noise_points</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_normals</span> <span class="o">=</span> <span class="n">noise_normals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">noise_colors</span> <span class="o">=</span> <span class="n">noise_colors</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

    <span class="c1"># ----------------- append to data_dict -----------------</span>
    <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">],</span> <span class="n">noise_points</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;norm&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="n">noise_normals</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;norm&quot;</span><span class="p">],</span> <span class="n">noise_normals</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;color&quot;</span> <span class="ow">in</span> <span class="n">data_dict</span> <span class="ow">and</span> <span class="n">noise_colors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">],</span> <span class="n">noise_colors</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># ----------------- noise_index -----------------</span>
    <span class="n">num_noise</span> <span class="o">=</span> <span class="n">noise_points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;noise_index&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="p">:</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ni</span><span class="p">[</span><span class="o">-</span><span class="n">num_noise</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">old_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">])</span>
        <span class="n">new_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;coord&quot;</span><span class="p">])</span>
        <span class="n">ni</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">new_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
        <span class="n">ni</span><span class="p">[:</span><span class="n">old_len</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s2">&quot;noise_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ni</span>

    <span class="k">return</span> <span class="n">data_dict</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Adding Noise</strong></p>
<p align="center">
  <img src="../img/AddNoise1.png" alt="Before" style="width:48%; max-width:48%; height:auto; margin-right:1%;">
  <img src="../img/AddNoise2.png" alt="After" style="width:48%; max-width:48%; height:auto; margin-left:1%;">
</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "..", "features": [], "search": "../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": "0.0.1"}</script>
    
    
      <script src="../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>